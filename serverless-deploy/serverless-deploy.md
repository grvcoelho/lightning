theme: simple
build-lists: true

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# Serverless Microservice

## Como deployar um microserviço serverless

---

![profile](https://user-images.githubusercontent.com/7416751/28267091-c4065702-6ace-11e7-9789-5060ec60aa7a.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![stone-pagarme inline 100%](https://user-images.githubusercontent.com/7416751/28395390-099c83e8-6cca-11e7-9a7a-dc9dfc9aadbb.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Fluxo Transação - Pagar.me

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Fluxo Transação - Pagar.me

![inline xxgatewayxx](https://user-images.githubusercontent.com/7416751/28253086-7c3229a0-6a75-11e7-88b3-b514eed51813.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Fluxo Transação - Boleto

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Fluxo Transação - Boleto

![inline xxboleto](https://user-images.githubusercontent.com/7416751/28253085-7c3155ca-6a75-11e7-99cc-2f29b34de167.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Fluxo Transação - Boleto Registrado

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Fluxo Transação - Boleto Registrado

![inline xxboleto-registrado](https://user-images.githubusercontent.com/7416751/28253084-7c2eaf8c-6a75-11e7-9d6e-5b924e630b30.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# :football:

## Superbowleto

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Superbowleto

![inline xxsuperbowleto](https://user-images.githubusercontent.com/7416751/28253087-7c4f36d0-6a75-11e7-95c1-2943a6b6c618.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Requisitos Superbowleto

- API Simples (CRUD)
- Salvar os dados em um banco de dados
- Fila para retentativa de registro de boleto
- Retorno via fila
- Ambientes idênticos live/sandbox

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :microscope: Tecnologia

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![nodejs-logo inline 100%](https://user-images.githubusercontent.com/7416751/28395686-2552161e-6ccc-11e7-85ab-62d6e4a0227a.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![typescript inline 100%](https://user-images.githubusercontent.com/7416751/28395718-72a7aed8-6ccc-11e7-80fb-c63caa311b30.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![webpack inline 35%](https://user-images.githubusercontent.com/7416751/28395747-ab7590cc-6ccc-11e7-9a4e-c1a7de8bf060.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![postgresql-logo inline 80%](https://user-images.githubusercontent.com/7416751/28395774-d7d788b4-6ccc-11e7-9ede-3476ef968ddd.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![sqs inline 35%](https://user-images.githubusercontent.com/7416751/28395807-1b61da26-6ccd-11e7-9d79-e6b6b36f48f6.png)

## AWS SQS

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :rocket: Deployando uma API Node.js

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Deployando uma API Node.js

- AutoScaling Group
- Load Balancing
- Clusters
- Service Discovery
- Monitoramento
- ...

^ 5 meses atrás, eu não tinha conta na Amazon e eu não sabia o quer era uma máquina EC2.
^ Quem Sou eu?
^ Entrei no Pagar.me 2 anos atrás para fazer jQuery
^ Há 4 meses estava fazendo coisas no core do Pagar.me
^ Não tinha nem conta na Amazon muito menos conhecimento de Infra

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Serverless

- API Gateway: endpoints da API
- AWS Lambda: Function as a Service
- AWS SQS: serviço de filas

^ A gente meio que que já tinha brincado com Serverless
^ Achamos que seria mais fácil de subir esta API usando Serverless

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Como criar funções Lambda

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## ![inline 80%](https://user-images.githubusercontent.com/7416751/28384097-c6fd1ae6-6c99-11e7-9b2c-dda86989e73b.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Serverless Framework

- `serverless.yml`
- Faz o deploy das Lambdas e API Gateway
- Gera configurações com CloudFormation
- Cria outros recursos com CloudFormation

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## serverless.yml - http

```yaml
create-boleto:
  handler: dist/boleto.create
  events:
    - http:
        path: /boletos
        method: post
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## serverless.yml - resultado

```yaml
service: superbowleto
stage: live
region: us-east-1

endpoints:
  POST - https://mc4evvg26b.execute-api.us-east-1.amazonaws.com/live/boletos
functions:
  create-boleto: live-superbowleto-create-boleto
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :computer: Criar outros recursos da aplicação

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Criar outros recursos da aplicação

- IAM: Roles, policies, permissions
- VPC: subnets, security\_groups, route\_tables
- SQS: queues
- RDS: database

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Serverless + CloudFormation

```yaml
resources:
 Resources:
   SuperbowletoQueue:
     Type: AWS::S3::SQS
     Properties:
       QueueName: boletos-to-register
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

![terraform inline 100%](https://user-images.githubusercontent.com/7416751/28382292-085d1cee-6c94-11e7-8e14-ffd8371be2bd.png)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Terraform

- Infrastructure as Code
- Execution Plans
- HCL, Variables, Interpolation, Modules, :sparkling_heart:
- Toda infra da Pagar.me hoje é Terraform :muscle:

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Terraform - Exemplo

```tcl
variable "delay" {
  type = "string"
}

resource "aws_queue" "superbowleto_queue" {
  queue_name = "boletos-to-register"
  delay_seconds = "${var.delay}"
}

output "queue_arn" {
  value = "${aws_queue.superbowleto_queue.arn}"
}
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Terraform - Módulos

```tcl
module "sandbox" {
  source  = "./application"
  network = "10.0.0.0/16"
  ...
}

module "live" {
  source  = "./application"
  network = "172.168.0.0/16"
  ...
}
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :globe_with_meridians: API Gateway - Endpoints públicos

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## API Gateway - Opções

- a) adicionar regras de autenticação
- b) criar um "custom authorizer"
- c) usar API Keys do API Gateway

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Serverless não suportava API Keys

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Serverless não suportava API Keys

- CloudFormation não tinha suporte a `Usage Plans`
- Criar `Usage Plan` no console da Amazon

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Usar Terraform para criar endpoints

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Usar Terraform para criar endpoints

- `rest_api`
- `api_resource`
- `api_method`
- `api_integration`
- `api_deployment`
- `lambda_permission`
- ...

^ O que eram três linhas com Serverless agora eram 80 com terraform

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Usar Terraform para criar endpoints

```ruby
module "create_endpoint" {
  source = "./api-endpoint"
  method = "POST"
  lambda = "${var.lambda}"
  path   = "${var.resource_path}"
}
```

^ Mas podemos usar módulos e abstrair todo trabalho sujo

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :key: Senha do banco de dados

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Senha do banco de dados

- Todo mundo pode ter acesso **read** na Amazon
- **Hard-coded**: senha plain-text no S3, no Cloudformation e na Lambda
- **Env Var**: senha plain-text na Lambda

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :closed_lock_with_key: Salvar senha no Credstash

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Credstash

- Banco de credenciais
- Key-Value store
- KMS + DynamoDB

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Salvar senha no Credstash

Deploy:

```
$ credstash put sandbox/database/password pass123
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Salvar senha no Credstash

Aplicação:

```javascript
function init () {
  return Promise.resolve()
    .then(() => credstash.get('sandbox/database/password'))
    .then(initDatabase)
    .then(runFunction)
}
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :key: Senha do banco de dados no `.tfstate`

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## `.tfstate`

- Representação da sua infraestrutura
- Sem criptografia :cry:
- Disponível no S3 (state\_lock) :globe_with_meridians:

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Script para atualizar banco de dados

```go
// Gera uma senha aleatória
password = generatePassword()

// Atualiza a instância do banco de dados
aws.updateDatabasePassword(password)

// Salva a senha no credstash
credstash.put('database/password', password)
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :rotating_light: Cross-referencing entre ferramentas

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Cross-referencing entre ferramentas

- Role (`terraform`) -> Lambda (`serverless`)
- Lambda (`serverless`) -> API Gateway (`terraform`)
- Database (`terraform`) -> Lambda Var (`serverless`)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Terraform everything!

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Terraform everything!

- Criar as Lambdas também com Terraform.
- Utilizar Serverless apenas para deployar as funções.

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Serverless não atualiza Lambdas já criadas

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :pager: Criar um deployer

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

### Como deployar uma função Lambda

- Zip source files
- Upload para o S3
- Atualiza o código das funções

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

![inline](https://user-images.githubusercontent.com/7416751/28267282-c397d77c-6acf-11e7-9d1e-b2629103b338.png)

## [github.com/pagarme/deployer](pagarme/deployer)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Deployer - Steps

- **SCM**: `git`
- **Build**: `rocker`
- **Deploy**: `nomad`, **`lambda`**

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Deployer - Lambda

```yml
scm:
  type: git
  repository: git@github.com:pagarme/superbowleto.git

build:
  type: rocker

deploy:
  type: lambda
  s3_bucket: deploy-bucket
  region: us-east-1
  package:
    - node_modules
    - handler.js

environment:
  live:
    functions:
      - create-boleto
      - update-boleto
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Deployer - Na prática

Run:
- `deployer deploy --ref "master" --env "live" superbowleto.yml`

Chatbot:
- `sharon deploy superbowleto/master to production/live`

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :turtle: Response time > 10s

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Response time > 10s

- Requests demorando constantemente 10, 11, 12 segundos
- Lambda esperar o Event Loop do Node se limpar
- Nós mantemos a conexão do banco de dados aberta

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## :rotating_light: Alterar o comportamento da Lambda

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Alterar o comportamento da Lambda

- `context.callbackWaitsForEmptyEventLoop`

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Alterar o comportamento da Lambda

```javascript
export const handler = (event, context, callback) => {
  context.callbackWaitsForEmptyEventLoop = false

  // ...
  callback(null, 'Success!')
}
```

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Migração de banco de dados

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Lambda que roda migrations

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

## Futuro

- :telescope: Monitoramento
- :book: Otimizações
- :roller_coaster: Escalabilidade

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![stone-co inline 90%](https://user-images.githubusercontent.com/7416751/28396257-a37fc8e8-6cd0-11e7-9561-3063a0370df5.png)

## stone.co + Open Source = :green_heart:

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

![inline](https://user-images.githubusercontent.com/7416751/28267341-18c57402-6ad0-11e7-81b4-0f802d999efb.png)

## [github.com/pagarme/superbowleto](https://github.com/pagarme/superbowleto)

---

![background](https://user-images.githubusercontent.com/7416751/28267089-c3fe87fc-6ace-11e7-9ad7-70f25b05d5a6.png)

# ![inline 50%](https://avatars1.githubusercontent.com/u/7416751?v=4&s=460)

## Obrigado :green_heart:

### [github.com/grvcoelho](github.com/grvcoelho)
